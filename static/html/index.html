<!DOCTYPE html>
<html xmlns:fb="http://www.facebook.com/2008/fbml">
<head>
    <title>Movies importer into Facebook</title>
</head>
<body>
<fb:login-button id="fb_login_button" scope="publish_actions" autologoutlink="true" size="large"></fb:login-button>

<h1>Import your IMDb rating history</h1>

<p>
    Go on your IMDb rating history.
    At the bottom of the page, use "Export this list" to download the CSV file.
    Use the downloaded file in the form bellow and submit.
</p>

<form id="process_form" method="post" action="/imdb" enctype="multipart/form-data">
    <label for="rating_history">Rating history (CSV export)</label>
    <input type="file" name="rating_history" id="rating_history"/>
    <input type="hidden" id="access_token" name="fb_access_token"/>
    <input type="hidden" id="user_id" name="fb_user_id"/>
    <input type="submit"/>
</form>

<div id="fb-root"></div>
<script>
    // callback when the user is connected on Facebook
    user_connected = function (response) {
        // fb-login is auto login/logout
        // $("#fb_login_button").hide();
        $('#process_form').show();
        $('#access_token').attr('value', response['authResponse']['accessToken']);
        $('#user_id').attr('value', response['authResponse'['userID']])
    }

    window.fbAsyncInit = function () {
        // init the FB JS SDK
        FB.init({
            appId: '608738222470406',                        // App ID from the app dashboard
            channelUrl: '//fb-movies.appspot.com/page/channel.html',   // Channel file for x-domain comms
            status: true,                                     // Check Facebook Login status
            xfbml: true                                      // Look for social plugins on the page
        });

        // Additional initialization code such as adding Event Listeners goes here
        FB.Event.subscribe('auth.login',
                function (response) {
                    user_connected(response);
                }
        );
        FB.Event.subscribe('auth.authResponseChange', function (response) {
            // alert('The status of the session is: ' + response.status);
            if (response.status === 'connected') {
                user_connected(response);
            }
        });
    };
</script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#process_form').hide();

        // Load the SDK asynchronously
        //TODO Locale
        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) {
                return;
            }
            js = d.createElement(s);
            js.id = id;
            js.src = "//connect.facebook.net/fr_FR/all.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
    });
</script>
</body>
</html>